<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–ø–∏—Å—å –≤ —Å–µ–∫—Ü–∏–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg-color: var(--tg-theme-bg-color, #fff);
      --text-color: var(--tg-theme-text-color, #222);
      --hint-color: var(--tg-theme-hint-color, #999);
      --btn-color: var(--tg-theme-button-color, #3390ec);
      --btn-text-color: var(--tg-theme-button-text-color, #fff);
      --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
      --red-color: #ff3b30;
      --green-color: #34c759;
    }
    body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color); font-family: -apple-system, sans-serif; }
    .container { padding: 16px; padding-bottom: 80px; }
    .hidden { display: none !important; }
    
    .btn { background: var(--btn-color); color: var(--btn-text-color); border: none; border-radius: 8px; padding: 12px 20px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 10px; }
    .btn:active { opacity: 0.8; }
    .btn.danger { background: var(--red-color); }
    .btn.outline { background: transparent; border: 1px solid var(--btn-color); color: var(--btn-color); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--hint-color); }
    
    .card { background: var(--secondary-bg); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 8px; }
    .card-header { display: flex; justify-content: space-between; align-items: start; }
    .card h3 { margin: 0; font-size: 18px; flex: 1; }
    .card p { margin: 0; color: var(--hint-color); font-size: 14px; }
    
    /* –ë–µ–π–¥–∂–∏–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–µ—Å—Ç */
    .badge { 
      font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 6px; background: #ddd; color: #555; white-space: nowrap; margin-left: 8px;
    }
    .badge.green { background: rgba(52, 199, 89, 0.2); color: var(--green-color); }
    .badge.red { background: rgba(255, 59, 48, 0.2); color: var(--red-color); }

    input, textarea { width: 100%; box-sizing: border-box; padding: 12px; border-radius: 8px; border: 1px solid var(--hint-color); background: var(--bg-color); color: var(--text-color); font-size: 16px; margin-bottom: 12px; outline: none; }
    input:focus, textarea:focus { border-color: var(--btn-color); }
    .password-input { border: 1px solid var(--red-color); }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { width: 100%; max-width: 400px; text-align: center; }

    .tabbar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: var(--secondary-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(0,0,0,0.1); z-index: 100; }
    .tab-btn { background: none; border: none; color: var(--hint-color); font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .tab-btn.active { color: var(--btn-color); font-weight: bold; }
    svg { width: 24px; height: 24px; fill: currentColor; }
    .role-switcher { text-align: center; padding: 10px; background: var(--secondary-bg); margin-bottom: 10px; font-size: 12px; color: var(--hint-color); }
    .role-switcher span { color: var(--btn-color); text-decoration: underline; cursor: pointer;}
  </style>
</head>
<body>

  <div id="view-registration" class="modal-overlay hidden">
    <div class="modal-box">
      <h2>–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è!</h2>
      <p style="color:var(--hint-color); margin-bottom:20px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Ä–µ–∞–ª—å–Ω–æ–µ –ò–º—è –∏ –§–∞–º–∏–ª–∏—é.</p>
      <input type="text" id="reg-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω">
      <button class="btn" onclick="app.saveUserName()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  </div>

  <div class="role-switcher">
    –†–µ–∂–∏–º: <b id="current-role-label">–£—á–µ–Ω–∏–∫</b> (<span id="display-username">...</span>)
    <br>
    <span onclick="app.toggleRole()">–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</span> | <span onclick="app.resetName()">–°–º–µ–Ω–∏—Ç—å –∏–º—è</span>
  </div>

  <div id="view-student-list" class="container">
    <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ–∫—Ü–∏–∏</h2>
    <div id="sections-list"></div>
  </div>

  <div id="view-student-profile" class="container hidden">
    <h2>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h2>
    <div id="my-registrations-list"><p style="color:var(--hint-color)">–ü—É—Å—Ç–æ</p></div>
  </div>

  <div id="view-teacher-dashboard" class="container hidden">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
    <button class="btn" onclick="app.openCreateForm()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é</button>
    <br><br>
    <div id="teacher-sections-list"></div>
  </div>

  <div id="view-details" class="container hidden">
    <h1 id="detail-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h1>
    <div id="detail-badge" style="margin-bottom: 10px; display: inline-block;"></div>
    
    <p id="detail-desc" style="white-space: pre-wrap;">–û–ø–∏—Å–∞–Ω–∏–µ</p>
    <p style="color: var(--hint-color)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: <span id="detail-schedule"></span></p>
    
    <div id="student-actions">
      <button id="btn-register" class="btn">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
      <button id="btn-unregister" class="btn danger hidden">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      <p id="msg-full" class="hidden" style="color: var(--red-color); text-align: center; font-weight: bold;">‚õî –ú–µ—Å—Ç –±–æ–ª—å—à–µ –Ω–µ—Ç</p>
    </div>

    <div id="teacher-actions" class="hidden">
      <h3>–£—á–µ–Ω–∏–∫–∏:</h3>
      <div id="students-list"></div>
      <br>
      <button class="btn outline" onclick="app.openEditForm()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn danger" onclick="app.deleteSection()">–£–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ü–∏—é</button>
    </div>
  </div>

  <div id="view-form" class="container hidden">
    <h2 id="form-title">–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è</h2>
    <input type="text" id="input-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <input type="text" id="input-schedule" placeholder="–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ">
    <textarea id="input-desc" rows="5" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    
    <p style="font-size:12px; color:var(--hint-color); margin-bottom:4px;">–ú–∞–∫—Å–∏–º—É–º —á–µ–ª–æ–≤–µ–∫ (0 = –±–µ–∑–ª–∏–º–∏—Ç):</p>
    <input type="number" id="input-limit" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10">

    <p style="font-size:12px; color:#ff3b30; margin-bottom:4px;">–ü–∞—Ä–æ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</p>
    <input type="password" id="input-password" class="password-input" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn" onclick="app.saveSection()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div id="tabbar" class="tabbar">
    <button class="tab-btn active" onclick="app.switchTab('list')">
      <svg viewBox="0 0 24 24"><path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/></svg>
      <span>–í—Å–µ —Å–µ–∫—Ü–∏–∏</span>
    </button>
    <button class="tab-btn" onclick="app.switchTab('profile')">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      <span>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</span>
    </button>
  </div>

<script>
// üî• –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ò–ó GOOGLE
const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwyhKo0oDhCe8Q8VN-U23YuESZULY7uOzIiw1dx2BOLQ0olm1uDismdJ91_53p_7k1J/exec"; 
const TEACHER_ACCESS_CODE = "1234";

const tg = window.Telegram.WebApp;
tg.expand();

const DB = {
  sections: [],
  registrations: [],
  user: {
    id: tg.initDataUnsafe?.user?.id || 12345, 
    name: "Guest", 
    role: 'student' 
  }
};

const app = {
  currentSectionId: null,
  isLoading: false,

  init: () => {
    tg.BackButton.onClick(() => {
      if (DB.user.role === 'teacher') app.showScreen('view-teacher-dashboard');
      else app.showScreen('view-student-list');
      tg.BackButton.hide();
    });
    app.checkUserName();
  },

  checkUserName: () => {
    const savedName = localStorage.getItem('student_full_name');
    if (savedName) {
      DB.user.name = savedName;
      document.getElementById('display-username').innerText = savedName;
      app.loadData();
    } else {
      document.getElementById('view-registration').classList.remove('hidden');
      document.getElementById('tabbar').classList.add('hidden');
    }
  },

  saveUserName: () => {
    const input = document.getElementById('reg-name');
    const name = input.value.trim();
    if (name.length < 2) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è");
    localStorage.setItem('student_full_name', name);
    DB.user.name = name;
    document.getElementById('view-registration').classList.add('hidden');
    document.getElementById('display-username').innerText = name;
    document.getElementById('tabbar').classList.remove('hidden');
    app.loadData();
  },

  resetName: () => {
    if(confirm("–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è?")) {
      localStorage.removeItem('student_full_name');
      window.location.reload();
    }
  },

  loadData: () => {
    document.getElementById('sections-list').innerHTML = '<p style="text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º getAllData, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ü–∏–∏ –∏ –∏—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å
    fetch(`${GOOGLE_URL}?action=getAllData&userId=${DB.user.id}`)
      .then(res => res.json())
      .then(data => {
        DB.sections = data.sections || [];
        DB.registrations = data.registrations || [];
        app.renderAll();
      });
  },

  toggleRegistration: (sectionId, isJoining) => {
    if (app.isLoading) return; 
    app.isLoading = true; tg.MainButton.showProgress();
    const btnReg = document.getElementById('btn-register');
    const btnUnreg = document.getElementById('btn-unregister');
    btnReg.disabled = true; btnUnreg.disabled = true;

    fetch(GOOGLE_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: isJoining ? 'JOIN' : 'LEAVE',
        userId: DB.user.id,
        userName: DB.user.name,
        sectionId: sectionId
      })
    })
    .then(res => res.json())
    .then(data => {
      tg.MainButton.hideProgress();
      app.isLoading = false; 
      btnReg.disabled = false; btnUnreg.disabled = false;

      if(data.status === 'success') {
        tg.showAlert(isJoining ? "–ó–∞–ø–∏—Å–∞–Ω–æ!" : "–û—Ç–º–µ–Ω–µ–Ω–æ!");
        app.loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –º–µ—Å—Ç
        app.showScreen('view-student-list');
      } else {
        tg.showAlert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
      }
    })
    .catch(() => {
      app.isLoading = false; tg.MainButton.hideProgress();
      btnReg.disabled = false; btnUnreg.disabled = false;
    });
  },

  kickStudent: (userId, sectionId) => {
    if (app.isLoading) return;
    const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —Å–µ–∫—Ü–∏–∏:");
    if (!pass) return;
    if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
    app.isLoading = true;
    document.getElementById('students-list').innerHTML = "–£–¥–∞–ª–µ–Ω–∏–µ...";
    fetch(GOOGLE_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'kickStudent', userId, sectionId, password: pass })
    })
    .then(res => res.json())
    .then(data => {
       app.isLoading = false;
       if (data.status === 'success') tg.showAlert("–£–¥–∞–ª–µ–Ω");
       else tg.showAlert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"));
       app.renderStudentsList(sectionId);
    });
  },

  saveSection: () => {
    const title = document.getElementById('input-title').value;
    const schedule = document.getElementById('input-schedule').value;
    const desc = document.getElementById('input-desc').value;
    const limit = document.getElementById('input-limit').value; // –ù–æ–≤–æ–µ –ø–æ–ª–µ
    const password = document.getElementById('input-password').value;

    if (!title) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
    if (!password) return tg.showAlert("–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–æ–ª—å!");

    if (app.isLoading) return;
    app.isLoading = true; tg.MainButton.showProgress();

    fetch(GOOGLE_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: app.currentSectionId ? 'editSection' : 'createSection',
        id: app.currentSectionId,
        title, schedule, desc, password, 
        limit: limit ? parseInt(limit) : 0 // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–∏–º–∏—Ç (–∏–ª–∏ 0)
      })
    })
    .then(res => res.json())
    .then(data => {
      app.isLoading = false; tg.MainButton.hideProgress();
      if (data.status === 'success') {
        tg.showAlert("–ì–æ—Ç–æ–≤–æ!");
        app.loadData();
        app.showScreen('view-teacher-dashboard');
      } else {
        alert("–û—à–∏–±–∫–∞: " + data.error);
      }
    });
  },

  deleteSection: () => {
    const pass = prompt("–ü–∞—Ä–æ–ª—å —Å–µ–∫—Ü–∏–∏:");
    if (!pass) return;
    if (app.isLoading) return;
    app.isLoading = true; tg.MainButton.showProgress();

    fetch(GOOGLE_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteSection', id: app.currentSectionId, password: pass })
    })
    .then(res => res.json())
    .then(data => {
      app.isLoading = false; tg.MainButton.hideProgress();
      if (data.status === 'success') {
        tg.showAlert("–£–¥–∞–ª–µ–Ω–æ");
        app.loadData();
        app.showScreen('view-teacher-dashboard');
      } else {
         alert("–û—à–∏–±–∫–∞: " + data.error);
      }
    });
  },

  renderStudentsList: (sectionId) => {
    const list = document.getElementById('students-list');
    list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    fetch(`${GOOGLE_URL}?action=getStudents&sectionId=${sectionId}`)
      .then(res => res.json())
      .then(students => {
        list.innerHTML = '';
        if (students.length === 0) { list.innerHTML = '<i>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</i>'; return; }
        students.forEach(st => {
          const div = document.createElement('div');
          div.style = "display: flex; justify-content: space-between; padding: 10px; border-bottom:1px solid #eee";
          div.innerHTML = `<span>${st.userName}</span><span style="color:red; cursor:pointer;" onclick="app.kickStudent(${st.userId}, ${sectionId})">–£–¥–∞–ª–∏—Ç—å</span>`;
          list.appendChild(div);
        });
      });
  },

  toggleRole: () => {
    if (DB.user.role === 'student') {
      const pass = prompt("–ü–∞—Ä–æ–ª—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è:");
      if (pass !== TEACHER_ACCESS_CODE) { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!"); return; }
      DB.user.role = 'teacher';
    } else { DB.user.role = 'student'; }
    document.getElementById('current-role-label').innerText = DB.user.role === 'student' ? '–£—á–µ–Ω–∏–∫' : '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å';
    if (DB.user.role === 'teacher') { document.getElementById('tabbar').classList.add('hidden'); app.showScreen('view-teacher-dashboard'); } 
    else { document.getElementById('tabbar').classList.remove('hidden'); app.showScreen('view-student-list'); }
  },

  switchTab: (tab) => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (tab === 'list') { app.showScreen('view-student-list'); document.querySelectorAll('.tab-btn')[0].classList.add('active'); } 
    else { app.showScreen('view-student-profile'); document.querySelectorAll('.tab-btn')[1].classList.add('active'); app.renderProfile(); }
  },
  showScreen: (screenId) => {
    document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
    tg.BackButton.hide();
  },
  renderAll: () => { app.renderStudentList(); app.renderTeacherDashboard(); },

  renderStudentList: () => {
    const list = document.getElementById('sections-list'); list.innerHTML = '';
    DB.sections.forEach(s => {
      const isReg = DB.registrations.some(r => r.sectionId == s.id);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–æ –º–µ—Å—Ç–∞
      let limitText = "";
      let isFull = false;
      if (s.limit > 0) {
        limitText = `<span class="badge ${s.count >= s.limit ? 'red' : 'green'}">${s.count} / ${s.limit}</span>`;
        if (s.count >= s.limit) isFull = true;
      }

      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
           <h3>${s.title} ${isReg ? '‚úÖ' : ''}</h3>
           ${limitText}
        </div>
        <p>${s.schedule}</p>
        <button class="btn outline" onclick="app.openDetails(${s.id})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
      `;
      list.appendChild(card);
    });
  },

  renderProfile: () => {
    const list = document.getElementById('my-registrations-list'); list.innerHTML = '';
    const mySecs = DB.sections.filter(s => DB.registrations.some(r => r.sectionId == s.id));
    if (mySecs.length === 0) { list.innerHTML = '<p style="color:#999">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>'; return; }
    mySecs.forEach(s => {
      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `<h3>${s.title}</h3><p>${s.schedule}</p><button class="btn outline" onclick="app.openDetails(${s.id})">–ò–Ω—Ñ–æ</button>`;
      list.appendChild(card);
    });
  },

  renderTeacherDashboard: () => {
    const list = document.getElementById('teacher-sections-list'); list.innerHTML = '';
    DB.sections.forEach(s => {
      const limitText = s.limit > 0 ? `(–õ–∏–º–∏—Ç: ${s.limit}, –ó–∞–Ω—è—Ç–æ: ${s.count})` : "(–ë–µ–∑–ª–∏–º–∏—Ç)";
      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `<h3>${s.title}</h3><p>${s.schedule}</p><p style="font-size:12px">${limitText}</p><button class="btn outline" onclick="app.openDetails(${s.id})">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>`;
      list.appendChild(card);
    });
  },

  openDetails: (id) => {
    app.currentSectionId = id;
    const s = DB.sections.find(sec => sec.id == id);
    if (!s) return;
    document.getElementById('detail-title').innerText = s.title;
    document.getElementById('detail-desc').innerText = s.desc;
    document.getElementById('detail-schedule').innerText = s.schedule;

    // –ë–µ–π–¥–∂ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const badgeDiv = document.getElementById('detail-badge');
    if (s.limit > 0) {
        badgeDiv.className = `badge ${s.count >= s.limit ? 'red' : 'green'}`;
        badgeDiv.innerText = `–ú–µ—Å—Ç–∞: ${s.count} –∏–∑ ${s.limit}`;
        badgeDiv.style.display = 'inline-block';
    } else {
        badgeDiv.style.display = 'none';
    }

    const studentBlock = document.getElementById('student-actions');
    const teacherBlock = document.getElementById('teacher-actions');

    if (DB.user.role === 'teacher') {
      studentBlock.classList.add('hidden'); teacherBlock.classList.remove('hidden'); app.renderStudentsList(id);
    } else {
      teacherBlock.classList.add('hidden'); studentBlock.classList.remove('hidden');
      const isReg = DB.registrations.some(r => r.sectionId == id);
      const btnReg = document.getElementById('btn-register'); 
      const btnUnreg = document.getElementById('btn-unregister');
      const msgFull = document.getElementById('msg-full');

      // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ —Å —É—á–µ—Ç–æ–º –º–µ—Å—Ç
      if (isReg) { 
        btnReg.classList.add('hidden'); 
        msgFull.classList.add('hidden');
        btnUnreg.classList.remove('hidden'); 
        btnUnreg.onclick = () => app.toggleRegistration(id, false); 
      } else { 
        btnUnreg.classList.add('hidden'); 
        
        // –ï—Å–ª–∏ –º–µ—Å—Ç –Ω–µ—Ç, –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è"
        if (s.limit > 0 && s.count >= s.limit) {
            btnReg.classList.add('hidden');
            msgFull.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ú–µ—Å—Ç –Ω–µ—Ç"
        } else {
            btnReg.classList.remove('hidden');
            msgFull.classList.add('hidden');
            btnReg.onclick = () => app.toggleRegistration(id, true); 
        }
      }
    }
    app.showScreen('view-details'); tg.BackButton.show();
  },

  openCreateForm: () => {
    app.currentSectionId = null;
    document.getElementById('form-title').innerText = "–ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è";
    document.getElementById('input-title').value = "";
    document.getElementById('input-schedule').value = "";
    document.getElementById('input-desc').value = "";
    document.getElementById('input-limit').value = "";
    document.getElementById('input-password').value = ""; 
    document.getElementById('input-password').placeholder = "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å";
    app.showScreen('view-form'); tg.BackButton.show();
  },

  openEditForm: () => {
    const s = DB.sections.find(sec => sec.id == app.currentSectionId);
    document.getElementById('form-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
    document.getElementById('input-title').value = s.title;
    document.getElementById('input-schedule').value = s.schedule;
    document.getElementById('input-desc').value = s.desc;
    document.getElementById('input-limit').value = s.limit || "";
    document.getElementById('input-password').value = ""; 
    document.getElementById('input-password').placeholder = "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
    app.showScreen('view-form'); tg.BackButton.show();
  }
};
app.init();
</script>
</body>
</html>
