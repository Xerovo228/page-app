<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Система записи</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #222222;
      --hint: #707579;
      --btn: #3390ec;
      --btn-text: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .container {
      width: 100%;
      max-width: 420px;
    }

    h1 { font-size: 24px; margin: 0 0 10px; }
    p  { margin: 0 0 24px; color: var(--hint); }

    .btn {
      width: 100%;
      padding: 15px;
      border: 0;
      border-radius: 12px;
      background: var(--btn);
      color: var(--btn-text);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity .15s;
    }
    .btn:active { opacity: .7; }
    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    #status-log {
      margin-top: 18px;
      font-size: 12px;
      text-align: left;
      background: #f2f2f2;
      padding: 10px;
      border-radius: 8px;
      display: none;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="user-name">Загрузка...</h1>
    <p id="instruction">Подождите, мы настраиваем приложение для вас.</p>

    <button class="btn" id="order-btn" type="button" disabled>Оставить заявку</button>

    <div id="status-log"></div>
  </div>

  <script>
    (function () {
      const header = document.getElementById("user-name");
      const instruction = document.getElementById("instruction");
      const logBox = document.getElementById("status-log");
      const orderBtn = document.getElementById("order-btn");

      // --- Helpers ---
      function showLog() {
        logBox.style.display = "block";
      }
      function log(msg) {
        showLog();
        logBox.textContent += (logBox.textContent ? "\n" : "") + "• " + msg;
      }

      function isTelegramWebApp() {
        return !!(window.Telegram && window.Telegram.WebApp);
      }

      function getTg() {
        return isTelegramWebApp() ? window.Telegram.WebApp : null;
      }

      function applyThemeFromTelegram(tg) {
        // Пытаемся использовать themeParams, если есть
        const tp = tg && tg.themeParams ? tg.themeParams : null;

        // Telegram может отдавать цвета в разных ключах; поддержим самые частые
        const bg = tp && (tp.bg_color || tp.secondary_bg_color);
        const text = tp && tp.text_color;
        const hint = tp && (tp.hint_color || tp.link_color);
        const btn = tp && (tp.button_color || tp.accent_text_color);
        const btnText = tp && (tp.button_text_color || tp.text_color);

        if (bg) document.documentElement.style.setProperty("--bg", bg);
        if (text) document.documentElement.style.setProperty("--text", text);
        if (hint) document.documentElement.style.setProperty("--hint", hint);
        if (btn) document.documentElement.style.setProperty("--btn", btn);
        if (btnText) document.documentElement.style.setProperty("--btn-text", btnText);
      }

      function setBrowserModeUI() {
        header.textContent = "Режим браузера";
        instruction.textContent = "Откройте эту страницу внутри Telegram-бота, чтобы отправить заявку.";
        orderBtn.disabled = false;
        log("Telegram WebApp не обнаружен (обычный браузер или SDK не загрузился).");
      }
function setTelegramModeUI(tg) {
        // Сообщаем Telegram что всё готово
        try {
          tg.ready();
          tg.expand();
        } catch (e) {
          log("tg.ready/tg.expand: " + e.message);
        }

        applyThemeFromTelegram(tg);

        // Подписка на смену темы (если поддерживается)
        try {
          tg.onEvent("themeChanged", () => applyThemeFromTelegram(tg));
        } catch (e) {
          // не критично
        }

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;

        if (user) {
          const name = user.first_name || "друг";
          header.textContent = Привет, ${name}!;
          instruction.textContent = "Нажмите кнопку ниже, чтобы отправить заявку.";
          orderBtn.disabled = false;
        } else {
          header.textContent = "Открыто не через кнопку WebApp";
          instruction.textContent = "Нужно открыть WebApp из бота (через кнопку), чтобы были данные пользователя.";
          orderBtn.disabled = true;
          log("Нет tg.initDataUnsafe.user. Откройте через кнопку web_app в боте.");
        }
      }

      // --- Action ---
      function sendOrder() {
        // На всякий случай: кнопка может быть нажата в любом окружении
        const tg = getTg();

        if (!tg) {
          alert("Откройте страницу внутри Telegram-бота.");
          log("Нажали кнопку в браузере: отправка невозможна без Telegram WebApp.");
          return;
        }

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if (!user) {
          alert("Нет данных пользователя. Откройте WebApp из бота через кнопку.");
          log("Попытка отправки без user в initDataUnsafe.");
          return;
        }

        // Можно отправлять строку или JSON строкой
        const payload = {
          type: "ORDER_REQUEST",
          ts: Date.now(),
          user_id: user.id
        };

        try {
          tg.sendData(JSON.stringify(payload));
          // закрывать не обязательно, но обычно удобно
          tg.close();
        } catch (e) {
          alert("Не удалось отправить данные: " + e.message);
          log("tg.sendData ошибка: " + e.message);
        }
      }

      // --- Init ---
      orderBtn.addEventListener("click", sendOrder);

      try {
        const tg = getTg();
        if (!tg) {
          setBrowserModeUI();
        } else {
          setTelegramModeUI(tg);
        }
      } catch (e) {
        header.textContent = "Сбой системы";
        instruction.textContent = "Произошла ошибка инициализации.";
        log("Ошибка инициализации: " + e.message);
        orderBtn.disabled = true;
      }
    })();
  </script>
</body>
</html>
